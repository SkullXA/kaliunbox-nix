name: Build KaliunBox ISOs

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Manual trigger

jobs:
  build-x86_64:
    name: Build x86_64 ISO
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            max-jobs = auto
            cores = 0

      - name: Setup Cachix (optional)
        uses: cachix/cachix-action@v15
        continue-on-error: true
        with:
          name: nix-community

      - name: Build x86_64 ISO
        run: |
          nix build .#packages.x86_64-linux.installer-iso --print-build-logs
          mkdir -p dist
          cp -L result/iso/*.iso dist/kaliunbox-x86_64.iso

      - name: Generate checksum
        run: |
          cd dist
          sha256sum kaliunbox-x86_64.iso > kaliunbox-x86_64.iso.sha256

      - name: Upload x86_64 ISO
        uses: actions/upload-artifact@v4
        with:
          name: kaliunbox-x86_64-iso
          path: |
            dist/kaliunbox-x86_64.iso
            dist/kaliunbox-x86_64.iso.sha256
          retention-days: 30

  build-aarch64:
    name: Build aarch64 ISO (ARM64 UEFI systems)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      # IMPORTANT: Setup QEMU BEFORE installing Nix
      - name: Setup QEMU for aarch64 emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            max-jobs = auto
            cores = 0
            extra-platforms = aarch64-linux

      - name: Setup Cachix (optional)
        uses: cachix/cachix-action@v15
        continue-on-error: true
        with:
          name: nix-community

      - name: Build aarch64 ISO
        run: |
          nix build .#packages.aarch64-linux.installer-iso --print-build-logs
          mkdir -p dist
          cp -L result/iso/*.iso dist/kaliunbox-aarch64.iso

      - name: Generate checksum
        run: |
          cd dist
          sha256sum kaliunbox-aarch64.iso > kaliunbox-aarch64.iso.sha256

      - name: Upload aarch64 ISO
        uses: actions/upload-artifact@v4
        with:
          name: kaliunbox-aarch64-iso
          path: |
            dist/kaliunbox-aarch64.iso
            dist/kaliunbox-aarch64.iso.sha256
          retention-days: 30

  build-rpi4:
    name: Build Raspberry Pi 4/5 SD Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: Setup QEMU for aarch64 emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            max-jobs = auto
            cores = 0
            extra-platforms = aarch64-linux

      - name: Setup Cachix (optional)
        uses: cachix/cachix-action@v15
        continue-on-error: true
        with:
          name: nix-community

      - name: Build Raspberry Pi 4 SD Image
        run: |
          nix build .#packages.aarch64-linux.rpi4-image --print-build-logs
          mkdir -p dist
          # SD image is compressed with zstd
          cp -L result/sd-image/*.img.zst dist/kaliunbox-rpi4.img.zst
          # Decompress for users who prefer raw image
          zstd -d dist/kaliunbox-rpi4.img.zst -o dist/kaliunbox-rpi4.img

      - name: Generate checksum
        run: |
          cd dist
          sha256sum kaliunbox-rpi4.img.zst > kaliunbox-rpi4.img.zst.sha256
          sha256sum kaliunbox-rpi4.img > kaliunbox-rpi4.img.sha256

      - name: Upload Raspberry Pi 4 SD Image
        uses: actions/upload-artifact@v4
        with:
          name: kaliunbox-rpi4-image
          path: |
            dist/kaliunbox-rpi4.img.zst
            dist/kaliunbox-rpi4.img.zst.sha256
          retention-days: 30

  # Create a release when a tag is pushed
  release:
    name: Create Release
    needs: [build-x86_64, build-aarch64, build-rpi4]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download x86_64 ISO
        uses: actions/download-artifact@v4
        with:
          name: kaliunbox-x86_64-iso
          path: dist

      - name: Download aarch64 ISO
        uses: actions/download-artifact@v4
        with:
          name: kaliunbox-aarch64-iso
          path: dist

      - name: Download Raspberry Pi 4 SD Image
        uses: actions/download-artifact@v4
        with:
          name: kaliunbox-rpi4-image
          path: dist

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/kaliunbox-x86_64.iso
            dist/kaliunbox-x86_64.iso.sha256
            dist/kaliunbox-aarch64.iso
            dist/kaliunbox-aarch64.iso.sha256
            dist/kaliunbox-rpi4.img.zst
            dist/kaliunbox-rpi4.img.zst.sha256
          generate_release_notes: true
