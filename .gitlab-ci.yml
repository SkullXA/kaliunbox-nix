workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

stages:
  - test
  - build
  - deploy

variables:
  NIX_IMAGE: "nixos/nix:latest"
  S3_BUCKET: "selorahomes-downloads"
  AWS_DEFAULT_REGION: "us-east-1"

# Template for Nix jobs
.nix-job:
  image: $NIX_IMAGE
  before_script:
    - mkdir -p ~/.config/nix
    - echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf
  cache:
    key: nix-${CI_JOB_NAME}
    paths:
      - /nix/store
      - /nix/var/nix
    policy: pull-push

# Rules for Nix-related changes
.nix-changes:
  rules:
    - if: $CI_COMMIT_TAG
    - changes:
        - "*.nix"
        - "**/*.nix"
        - flake.lock
        - .gitlab-ci.yml

# Rules for package-related changes
.pkg-changes:
  rules:
    - if: $CI_COMMIT_TAG
    - changes:
        - "pkgs/**/*"
        - flake.nix
        - flake.lock
        - .gitlab-ci.yml

# Run shell script unit tests
script-tests:
  extends: .nix-job
  stage: test
  script:
    - echo "Running shell script tests..."
    - nix shell nixpkgs#bats nixpkgs#python3 -c bats tests/
  rules:
    - if: $CI_COMMIT_TAG
    - changes:
        - "installer/**/*.sh"
        - "tests/**/*"
        - .gitlab-ci.yml

# Validate flake configuration
flake-check:
  extends:
    - .nix-job
    - .nix-changes
  stage: test
  script:
    - echo "Validating flake configuration..."
    - nix flake check --no-build

format-check:
  extends:
    - .nix-job
    - .nix-changes
  stage: test
  script:
    - echo "Checking Nix code formatting with alejandra..."
    - nix fmt -- --check .

flake-lock-check:
  extends: .nix-job
  stage: test
  script:
    - echo "Checking if flake.lock is up to date..."
    - nix flake lock
    - git diff --exit-code flake.lock
  rules:
    - if: $CI_COMMIT_TAG
    - changes:
        - flake.nix
        - flake.lock
        - .gitlab-ci.yml
  allow_failure: true

nix-lint:
  extends:
    - .nix-job
    - .nix-changes
  stage: test
  script:
    - echo "Running Nix linter..."
    - nix run nixpkgs#statix --no-write-lock-file -- check .

# Build system configuration
build-system:
  extends:
    - .nix-job
    - .nix-changes
  stage: build
  script:
    - echo "Building SeloraBox system configuration..."
    - nix build .#nixosConfigurations.selorabox.config.system.build.toplevel

# Template for ISO build jobs with S3 upload
.iso-build:
  extends: .nix-job
  stage: build
  variables:
    AWS_ROLE_ARN: "${S3_UPLOAD_ROLE_ARN}"
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: https://gitlab.com
  before_script:
    - mkdir -p ~/.config/nix
    - echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf
    - nix-env -iA nixpkgs.awscli2
    - |
      export $(printf "AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s" \
        $(aws sts assume-role-with-web-identity \
          --role-arn ${AWS_ROLE_ARN} \
          --role-session-name "GitLabRunner-${CI_PROJECT_ID}-${CI_PIPELINE_ID}" \
          --web-identity-token ${GITLAB_OIDC_TOKEN} \
          --duration-seconds 3600 \
          --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' \
          --output text))
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - "*.nix"
        - "**/*.nix"
        - flake.lock
        - "installer/**/*"
        - .gitlab-ci.yml
      when: manual
  timeout: 2h

# Build x86_64 ISO (default runner, no tags needed)
build-iso-x86_64:
  extends: .iso-build
  script:
    - echo "Building SeloraBox x86_64 installer ISO..."
    - nix build .#packages.x86_64-linux.installer-iso
    - |
      # Determine version from tag or commit
      if [ -n "$CI_COMMIT_TAG" ]; then
        VERSION="${CI_COMMIT_TAG}"
      else
        VERSION="${CI_COMMIT_SHORT_SHA}"
      fi
      FILENAME="selorabox-${VERSION}-x86_64.iso"
      echo "Uploading as ${FILENAME}..."
      sha256sum result/iso/*.iso | cut -d' ' -f1 > checksum.sha256
      aws s3 cp result/iso/*.iso "s3://${S3_BUCKET}/${FILENAME}" --no-progress
      aws s3 cp checksum.sha256 "s3://${S3_BUCKET}/${FILENAME}.sha256" --no-progress
      echo "[OK] Uploaded ${FILENAME}"

# Build aarch64 ISO on ARM runner
build-iso-aarch64:
  extends: .iso-build
  tags:
    - saas-linux-small-arm64
  script:
    - echo "Building SeloraBox aarch64 installer ISO..."
    - nix build .#packages.aarch64-linux.installer-iso
    - |
      # Determine version from tag or commit
      if [ -n "$CI_COMMIT_TAG" ]; then
        VERSION="${CI_COMMIT_TAG}"
      else
        VERSION="${CI_COMMIT_SHORT_SHA}"
      fi
      FILENAME="selorabox-${VERSION}-aarch64.iso"
      echo "Uploading as ${FILENAME}..."
      sha256sum result/iso/*.iso | cut -d' ' -f1 > checksum.sha256
      aws s3 cp result/iso/*.iso "s3://${S3_BUCKET}/${FILENAME}" --no-progress
      aws s3 cp checksum.sha256 "s3://${S3_BUCKET}/${FILENAME}.sha256" --no-progress
      echo "[OK] Uploaded ${FILENAME}"

# Build custom packages
build-packages:
  extends:
    - .nix-job
    - .pkg-changes
  stage: build
  script:
    - echo "Building custom packages..."
    - nix build .#packages.x86_64-linux.fosrl-newt
    - nix build .#packages.x86_64-linux.qrencode-large
  allow_failure: true

# Update downloads index page
update-index:
  stage: deploy
  image:
    name: amazon/aws-cli:latest
    entrypoint: [""]
  variables:
    AWS_ROLE_ARN: "${S3_UPLOAD_ROLE_ARN}"
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: https://gitlab.com
  before_script:
    - |
      export $(printf "AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s" \
        $(aws sts assume-role-with-web-identity \
          --role-arn ${AWS_ROLE_ARN} \
          --role-session-name "GitLabRunner-${CI_PROJECT_ID}-${CI_PIPELINE_ID}" \
          --web-identity-token ${GITLAB_OIDC_TOKEN} \
          --duration-seconds 3600 \
          --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' \
          --output text))
  script:
    - yum install -y jq
    # Generate index.html with file listing
    - |
      echo "Generating download page..."

      # Collect ISO metadata into a temp file
      ISOS_DATA=$(mktemp)
      aws s3api list-objects-v2 --bucket ${S3_BUCKET} --query 'Contents[?ends_with(Key, `.iso`)]' --output json | \
      jq -r '.[] | .Key' | while read -r isofile; do
        # Extract version from filename (e.g., selorabox-v1.2.3-x86_64.iso -> v1.2.3)
        version=$(echo "$isofile" | sed -E 's/selorabox-([^-]+(-[^-]+)?)-[^-]+\.iso/\1/')
        arch=$(echo "$isofile" | sed -E 's/selorabox-[^-]+(-[^-]+)?-([^.]+)\.iso/\2/')
        size=$(aws s3api head-object --bucket ${S3_BUCKET} --key "$isofile" --query 'ContentLength' --output text)
        size_mb=$((size / 1024 / 1024))
        lastmod=$(aws s3api head-object --bucket ${S3_BUCKET} --key "$isofile" --query 'LastModified' --output text)
        lastmod_date=$(echo "$lastmod" | cut -d'T' -f1)
        checksum=$(aws s3 cp "s3://${S3_BUCKET}/${isofile}.sha256" - 2>/dev/null || echo "")
        echo "${version}|${arch}|${isofile}|${size_mb}|${lastmod_date}|${lastmod}|${checksum}" >> "$ISOS_DATA"
      done

      # Sort by date (newest first) and get unique versions in order
      VERSIONS=$(sort -t'|' -k6 -r "$ISOS_DATA" | cut -d'|' -f1 | uniq)
      LATEST_VERSION=$(echo "$VERSIONS" | head -1)

      cat > index.html <<'EOF'
      <!DOCTYPE html>
      <html lang="en">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>SeloraBox ISO Downloads</title>
          <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
                  background: #181819;
                  color: #e5e5e5;
                  min-height: 100vh;
                  padding: 40px 20px;
              }
              .container {
                  max-width: 1200px;
                  margin: 0 auto;
                  background: #272729;
                  border: 1px solid #c7ae6a;
                  border-radius: 12px;
                  padding: 40px;
                  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
              }
              .header {
                  display: flex;
                  align-items: center;
                  gap: 20px;
                  margin-bottom: 10px;
              }
              .header img {
                  height: 60px;
                  width: 60px;
                  object-fit: contain;
              }
              h1 { color: #c7ae6a; font-size: 2rem; }
              h2 { color: #c7ae6a; margin: 30px 0 15px 0; font-size: 1.4rem; }
              .subtitle { color: #a0a0a0; margin-bottom: 30px; font-size: 1.1rem; }
              .latest-section {
                  background: #1a1a1b;
                  border: 2px solid #c7ae6a;
                  border-radius: 12px;
                  padding: 30px;
                  margin: 20px 0 40px 0;
              }
              .latest-header {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 20px;
              }
              .latest-version {
                  font-size: 1.8rem;
                  color: #c7ae6a;
                  font-weight: 700;
              }
              .latest-badge {
                  background: transparent;
                  color: #c7ae6a;
                  padding: 6px 16px;
                  border: 1px solid #c7ae6a;
                  border-radius: 20px;
                  font-weight: 600;
                  font-size: 0.9rem;
              }
              .latest-downloads {
                  display: flex;
                  gap: 20px;
                  flex-wrap: wrap;
              }
              .download-card {
                  background: #272729;
                  border: 1px solid #3a3a3c;
                  border-radius: 8px;
                  padding: 20px;
                  flex: 1;
                  min-width: 280px;
              }
              .download-card h3 {
                  color: #e5e5e5;
                  margin-bottom: 10px;
                  font-size: 1.1rem;
              }
              .download-card .meta {
                  color: #808080;
                  font-size: 0.9rem;
                  margin-bottom: 15px;
              }
              .download-card .checksum {
                  font-family: monospace;
                  font-size: 0.75rem;
                  color: #606060;
                  word-break: break-all;
                  margin-bottom: 15px;
              }
              table { border-collapse: collapse; width: 100%; margin-top: 20px; }
              th, td { border: 1px solid #3a3a3c; padding: 12px 16px; text-align: left; }
              th {
                  background: #1a1a1b;
                  color: #c7ae6a;
                  font-weight: 600;
                  border-bottom: 2px solid #c7ae6a;
              }
              tr { transition: background-color 0.2s; }
              tr:hover { background-color: #2a2a2c; }
              a { color: #c7ae6a; text-decoration: none; font-weight: 600; transition: color 0.2s; }
              a:hover { color: #d4bf7a; text-decoration: underline; }
              .download-btn {
                  background: #c7ae6a;
                  color: #181819;
                  padding: 8px 20px;
                  border-radius: 6px;
                  display: inline-block;
                  transition: all 0.2s;
                  font-weight: 600;
              }
              .download-btn:hover {
                  background: #d4bf7a;
                  color: #181819;
                  transform: translateY(-2px);
                  text-decoration: none;
                  box-shadow: 0 4px 12px rgba(199, 174, 106, 0.3);
              }
              .download-btn-small {
                  background: #3a3a3c;
                  color: #e5e5e5;
                  padding: 6px 14px;
                  border-radius: 4px;
                  font-size: 0.9rem;
              }
              .download-btn-small:hover {
                  background: #4a4a4c;
              }
              .release-notes-link {
                  font-weight: normal;
                  font-size: 0.9rem;
              }
              .footer {
                  margin-top: 40px;
                  text-align: center;
                  color: #808080;
                  font-size: 0.9em;
                  border-top: 1px solid #3a3a3c;
                  padding-top: 20px;
              }
              .footer a { color: #c7ae6a; }
          </style>
      </head>
      <body>
          <div class="container">
              <div class="header">
                  <img src="https://selorahomes.com/selora-logo.png" alt="Selora Homes">
                  <h1>SeloraBox ISO Downloads</h1>
              </div>
              <p class="subtitle">NixOS-based home automation appliance images</p>
      EOF

      # Generate latest version section
      if [ -n "$LATEST_VERSION" ]; then
        echo "<div class=\"latest-section\">" >> index.html
        echo "<div class=\"latest-header\">" >> index.html
        echo "<span class=\"latest-version\">$LATEST_VERSION</span>" >> index.html
        echo "<span class=\"latest-badge\">Latest Release</span>" >> index.html
        echo "</div>" >> index.html
        echo "<p style=\"margin-bottom: 20px;\"><a href=\"https://gitlab.com/SeloraHomes/products/selorabox-nix/-/releases/$LATEST_VERSION\" class=\"release-notes-link\">View Release Notes →</a></p>" >> index.html
        echo "<div class=\"latest-downloads\">" >> index.html

        grep "^${LATEST_VERSION}|" "$ISOS_DATA" | while IFS='|' read -r ver arch isofile size_mb lastmod_date lastmod checksum; do
          echo "<div class=\"download-card\">" >> index.html
          echo "<h3>$arch</h3>" >> index.html
          echo "<p class=\"meta\">${size_mb} MB • $lastmod_date</p>" >> index.html
          if [ -n "$checksum" ] && [ ${#checksum} -eq 64 ]; then
            echo "<p class=\"checksum\">SHA256: $checksum</p>" >> index.html
          fi
          echo "<a href=\"https://downloads.selorahomes.com/$isofile\" class=\"download-btn\">Download</a>" >> index.html
          if [ -n "$checksum" ] && [ ${#checksum} -eq 64 ]; then
            echo " <a href=\"https://downloads.selorahomes.com/${isofile}.sha256\" class=\"download-btn-small\">Checksum</a>" >> index.html
          fi
          echo "</div>" >> index.html
        done

        echo "</div></div>" >> index.html
      fi

      # Generate older versions table
      OLDER_VERSIONS=$(echo "$VERSIONS" | tail -n +2)
      if [ -n "$OLDER_VERSIONS" ]; then
        cat >> index.html <<'EOF'
              <h2>Previous Releases</h2>
              <table>
                  <thead>
                      <tr>
                          <th>Version</th>
                          <th>Architecture</th>
                          <th>Size</th>
                          <th>Date</th>
                          <th>Release Notes</th>
                          <th>Download</th>
                      </tr>
                  </thead>
                  <tbody>
      EOF

        echo "$OLDER_VERSIONS" | while read -r version; do
          grep "^${version}|" "$ISOS_DATA" | while IFS='|' read -r ver arch isofile size_mb lastmod_date lastmod checksum; do
            release_url="https://gitlab.com/SeloraHomes/products/selorabox-nix/-/releases/$version"
            echo "<tr>" >> index.html
            echo "<td>$version</td>" >> index.html
            echo "<td>$arch</td>" >> index.html
            echo "<td>${size_mb} MB</td>" >> index.html
            echo "<td>$lastmod_date</td>" >> index.html
            echo "<td><a href=\"$release_url\">View</a></td>" >> index.html
            echo "<td><a href=\"https://downloads.selorahomes.com/$isofile\" class=\"download-btn-small\">Download</a></td>" >> index.html
            echo "</tr>" >> index.html
          done
        done

        echo "</tbody></table>" >> index.html
      fi

      cat >> index.html <<EOF
              <div class="footer">
                  <p>Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")</p>
                  <p><a href="https://selorahomes.com">SeloraHomes.com</a> | <a href="https://gitlab.com/SeloraHomes/products/selorabox-nix">GitLab Repository</a></p>
              </div>
          </div>
      </body>
      </html>
      EOF

      rm -f "$ISOS_DATA"

    - aws s3 cp index.html "s3://${S3_BUCKET}/index.html" --content-type "text/html" --no-progress
    - echo "[OK] Uploaded index.html"
    # Invalidate CloudFront cache
    - DISTRIBUTION_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?Aliases.Items[?contains(@, 'downloads.selorahomes.com')]].Id" --output text 2>/dev/null || echo "")
    - |
      if [ -n "$DISTRIBUTION_ID" ]; then
        echo "Invalidating CloudFront cache for distribution: $DISTRIBUTION_ID"
        aws cloudfront create-invalidation --distribution-id ${DISTRIBUTION_ID} --paths "/*"
        echo "[OK] CloudFront cache invalidated"
      else
        echo "[WARN] CloudFront distribution not found, skipping cache invalidation"
      fi
    - echo "[OK] Update completed! ISOs available at https://downloads.selorahomes.com/"
  needs:
    - job: build-iso-x86_64
      optional: true
    - job: build-iso-aarch64
      optional: true
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual

release:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build-iso-x86_64
      optional: false
    - job: build-iso-aarch64
      optional: true
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    name: $CI_COMMIT_TAG
    description: |
      ## SeloraBox $CI_COMMIT_TAG

      ### Documentation
      - [Installation Guide](https://selorahomes.com/docs/selorabox/installation/)

      ### Downloads
      - [x86_64 ISO](https://downloads.selorahomes.com/selorabox-$CI_COMMIT_TAG-x86_64.iso) ([SHA256](https://downloads.selorahomes.com/selorabox-$CI_COMMIT_TAG-x86_64.iso.sha256))
      - [aarch64 ISO](https://downloads.selorahomes.com/selorabox-$CI_COMMIT_TAG-aarch64.iso) ([SHA256](https://downloads.selorahomes.com/selorabox-$CI_COMMIT_TAG-aarch64.iso.sha256))
    assets:
      links:
        - name: "SeloraBox x86_64 ISO"
          url: "https://downloads.selorahomes.com/selorabox-${CI_COMMIT_TAG}-x86_64.iso"
          link_type: package
        - name: "SeloraBox aarch64 ISO"
          url: "https://downloads.selorahomes.com/selorabox-${CI_COMMIT_TAG}-aarch64.iso"
          link_type: package
        - name: "Installation Guide"
          url: "https://selorahomes.com/docs/selorabox/installation/"
          link_type: other
